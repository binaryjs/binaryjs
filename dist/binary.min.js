/*! binary.min.js build:0.0.0, production. Copyright(c) 2012 Eric Zhang <eric@ericzhang.com> MIT Licensed */
function BinaryStream(e,t,n,r){if(!(this instanceof BinaryStream))return new BinaryStream(options);var i=this;Stream.call(this),this.id=t,this._socket=e,this._socket.addEventListener("error",function(e){i.readable=!1,i.writable=!1,i.emit("error",e)}),this._socket.addEventListener("close",function(e,t){i.readable=!1,i.writable=!1,i.emit("close",e,t)}),this.writable=!0,this.readable=!0,this._paused=!1,n&&this._write(1,r,this.id)}function BinaryClient(e){if(!(this instanceof BinaryClient))return new BinaryClient(options);EventEmitter.call(this);var t=this;this._streams={},this._nextId=0,typeof e=="string"?this._socket=new WebSocket(e):this._socket=e,this._socket.binaryType="arraybuffer",this._socket.addEventListener("error",function(e){t.emit("error",e)}),this._socket.addEventListener("close",function(e,n){t.emit("close",e,n)}),this._socket.addEventListener("message",function(e,n){e.hasOwnProperty("data")&&(e=e.data),e=util.unpack(e);switch(e[0]){case 0:break;case 1:var r=e[1],i=e[2],s=t._receiveStream(i);t.emit("stream",s,r);break;case 2:var o=e[1],i=e[2],s=t._streams[i];s?s._onData(o):t.emit("error","Received `data` message for unknown stream: "+i);break;case 3:var i=e[2],s=t._streams[i];s?s._onPause():t.emit("error","Received `pause` message for unknown stream: "+i);break;case 4:var i=e[2],s=t._streams[i];s?s._onResume():t.emit("error","Received `resume` message for unknown stream: "+i);break;case 5:var i=e[2],s=t._streams[i];s?s._onEnd():t.emit("error","Received `end` message for unknown stream: "+i);break;case 6:var i=e[2],s=t._streams[i];s?(s._onClose(),delete t._streams[i]):t.emit("error","Received `close` message for unknown stream: "+i);break;default:t.emit("error","Unrecognized message type received: "+e[0])}})}(function(e){"use strict";function t(){this._events={},this._maxListeners=10}function n(e,t,n,r,i){this.type=e,this.listener=t,this.scope=n,this.once=r,this.instance=i}n.prototype.fire=function(e){this.listener.apply(this.scope||this.instance,e);if(this.once)return this.instance.removeListener(this.type,this.listener,this.scope),!1},t.prototype.eachListener=function(e,t){var n=null,r=null,i=null;if(this._events.hasOwnProperty(e)){r=this._events[e];for(n=0;n<r.length;n+=1){i=t.call(this,r[n],n);if(i===!1)n-=1;else if(i===!0)break}}return this},t.prototype.addListener=function(e,t,r,i){return this._events.hasOwnProperty(e)||(this._events[e]=[]),this._events[e].push(new n(e,t,r,i,this)),this.emit("newListener",e,t,r,i),this._maxListeners&&!this._events[e].warned&&this._events[e].length>this._maxListeners&&(typeof console!="undefined"&&console.warn("Possible EventEmitter memory leak detected. "+this._events[e].length+" listeners added. Use emitter.setMaxListeners() to increase limit."),this._events[e].warned=!0),this},t.prototype.on=t.prototype.addListener,t.prototype.once=function(e,t,n){return this.addListener(e,t,n,!0)},t.prototype.removeListener=function(e,t,n){return this.eachListener(e,function(r,i){r.listener===t&&(!n||r.scope===n)&&this._events[e].splice(i,1)}),this._events[e]&&this._events[e].length===0&&delete this._events[e],this},t.prototype.off=t.prototype.removeListener,t.prototype.removeAllListeners=function(e){return e&&this._events.hasOwnProperty(e)?delete this._events[e]:e||(this._events={}),this},t.prototype.listeners=function(e){if(this._events.hasOwnProperty(e)){var t=[];return this.eachListener(e,function(e){t.push(e.listener)}),t}return[]},t.prototype.emit=function(e){var t=[],n=null;for(n=1;n<arguments.length;n+=1)t.push(arguments[n]);return this.eachListener(e,function(e){return e.fire(t)}),this},t.prototype.setMaxListeners=function(e){return this._maxListeners=e,this},t.extend=function(){var e={},t=this.prototype,n=null;for(n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);return e},typeof define=="function"&&define.amd&&define(function(){return t}),e.EventEmitter=t})(this);var util={inherits:function(e,t){e.super_=t,e.prototype=Object.create(t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}})},info:console.log.bind(console),warning:function(){},error:function(){},pack:BinaryPack.pack,unpack:BinaryPack.unpack},Stream=EventEmitter;util.inherits(BinaryStream,Stream),BinaryStream.prototype._onClose=function(){this.readable=!1,this.writable=!1,this.emit("close")},BinaryStream.prototype._onPause=function(){this.emit("pause"),this._paused=!0},BinaryStream.prototype._onResume=function(){this.emit("resume"),this.emit("drain"),this._paused=!1},BinaryStream.prototype._write=function(e,t,n,r){var i=util.pack([e,t,n]);return this._socket.send(i,{binary:!0},r)!==!1},BinaryStream.prototype.write=function(e,t){if(this.writable){var n=this._write(2,e,this.id,t);return console.log(n),!this._paused&&n}throw new Error("Stream is not writable")},BinaryStream.prototype.end=function(){this.readable=!1,this._write(5,null,this.id)},BinaryStream.prototype.destroy=BinaryStream.prototype.destroySoon=function(){this.readable=!1,this.writable=!1,this._write(6,null,this.id)},BinaryStream.prototype._onEnd=function(){this.readable=!1,this.emit("end")},BinaryStream.prototype._onData=function(e){this.readable&&this.emit("data",e)},BinaryStream.prototype.pause=function(){this._onPause(),this._write(3,null,this.id)},BinaryStream.prototype.resume=function(){this._onResume(),this._write(4,null,this.id)},util.inherits(BinaryClient,EventEmitter),BinaryClient.prototype.send=function(e,t){if(e instanceof Stream)e.pipe(this.createStream(t));else var n=this.createStream(t)},BinaryClient.prototype._receiveStream=function(e){var t=new BinaryStream(this._socket,e,!1);return this._streams[e]=t,t},BinaryClient.prototype.createStream=function(e){var t=this._nextId;this._nextId+=2;var n=new BinaryStream(this._socket,t,!0,e);return this._streams[t]=n,n},BinaryClient.prototype.close=BinaryClient.prototype.destroy=function(e,t){this._socket.close(e,t)}